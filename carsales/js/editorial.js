'use strict';var editorialApp=angular.module('editorialApp',['ngTouch','ui.router','ngResource','ngSanitize','ngMaterial','infinite-scroll','angular-carousel','csnGlobalSettings','csnAdvert','csnShareThis','csnCommon','csnVideoPlayer','csnCommentControl','csnTracking','csnNav','ngAnimate','toaster','duScroll']);editorialApp.config(['$stateProvider','$locationProvider','$urlRouterProvider','$httpProvider',function($stateProvider,$locationProvider,$urlRouterProvider,$httpProvider){$httpProvider.interceptors.push('httpErrorInterceptor');$httpProvider.defaults.withCredentials=true;}]);'use strict';editorialApp.controller('EditorialDetailsController',['$scope','$rootScope','$stateParams','editorialDetailService','commonViewModel','editorialListingScrollDatasource','$location','$sce','scrollHelper',function($scope,$rootScope,$stateParams,editorialDetailService,commonViewModel,editorialListingScrollDatasource,$location,$sce,scrollHelper){commonViewModel.resetForEditorial();$scope.model={};$scope.request={};$scope.request.params=$stateParams;$scope.request.id=$stateParams.id;$scope.request.index=parseInt($stateParams.index||0);$scope.model.currentAbsUrl=$location.absUrl();commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'Back to News',state:{name:'editorial',params:{}}});commonViewModel.headerMenus.push({text:'New Search',state:{name:'editorialSearch',params:{}}});editorialDetailService.get({id:$scope.request.id},function(detail){if(detail){$scope.model.detail=detail;$scope.model.detail.mainImageUrl=detail.photos[0];for(var i=0;i<detail.photos.length;i++){var url=detail.photos[i];$scope.model.detail.photos[i]={index:i,url:url};};$scope.model.detail.currentPhotoIndex=0;$rootScope.$on('mobiCarousel.slide',function(ev,obj){$scope.model.detail.currentPhotoIndex=obj.index+1;$scope.$apply();});$scope.model.detail.bodyCopy=$sce.trustAsHtml($scope.model.detail.bodyCopy);commonViewModel.pageTitle=detail.headline;commonViewModel.headerText=detail.type;}},function(){$scope.model.noRecordFound=true;});$scope.showComments=false;$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){if($scope.request.params.q){$scope.showRelatedItems=true;var prepopulateDataLimit=fromParams.index||0;$scope.model.listingDatasource=new editorialListingScrollDatasource($scope.request.params,$scope.request.index+1,prepopulateDataLimit,function(){if(fromParams.id){scrollHelper.scrollToElement(fromParams.id,0,0,3);}});}});}]);'use strict';editorialApp.controller('EditorialLandingController',['$rootScope','$scope','editorialLandingService','scrollHelper','commonViewModel','headerMenuItem','$state','webTrendsHelper',function($scope,$rootScope,editorialLandingService,scrollHelper,commonViewModel,headerMenuItem,$state,webTrendsHelper){commonViewModel.resetForEditorial();$scope.model={};$scope.model=editorialLandingService.get();commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'New Search',state:{name:'editorialSearch',params:{}}});$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){if(fromParams.id){scrollHelper.scrollToElement(fromParams.id,3);}});}]);'use strict';editorialApp.controller('EditorialListingController',['$scope','$rootScope','$state','$stateParams','editorialListingScrollDatasource','commonViewModel','scrollHelper','headerMenuItem',function($scope,$rootScope,$state,$stateParams,editorialListingScrollDatasource,commonViewModel,scrollHelper,headerMenuItem){commonViewModel.resetForEditorial();commonViewModel.headerText=$stateParams.title||"Results";$scope.model={};$scope.request={};$scope.request.params=$stateParams;commonViewModel.footerVisible=false;commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'Refine',state:{name:'editorialSearch',params:$state.params}});commonViewModel.headerMenus.push({text:'Sort',state:{name:'editorialListingSortBy',params:$state.params}});$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var prepopulateDataLimit=fromParams.index||0;$scope.model.listingDatasource=new editorialListingScrollDatasource($scope.request.params,0,prepopulateDataLimit,function(){if(fromParams.id){scrollHelper.scrollToElement(fromParams.id,0,0,3);}});});}]);'use strict';editorialApp.controller('EditorialListingSortByController',['$scope','$stateParams','commonViewModel',function($scope,$stateParams,commonViewModel){commonViewModel.resetForEditorial();commonViewModel.headerText='Sort by';$scope.model={};$scope.model.query=$stateParams.q;$scope.model.currentSort=$stateParams.sort;$scope.model.options=[{text:'Latest Articles',key:'latest'},{text:'Oldest Articles',key:'oldest'},{text:'Title (A-Z)',key:'title'},{text:'Title (Z-A)',key:'~title'}];}]);'use strict';editorialApp.controller('EditorialSearchController',['$scope','navigateService','commonViewModel','backButtonService','$state','$stateParams','editorialNavApiService','scrollHelper','navigationBreadcrumb','urlStringService','$window',function($scope,navigateService,commonViewModel,backButtonService,$state,$stateParams,editorialNavApiService,scrollHelper,navigationBreadcrumb,urlStringService,$window){commonViewModel.resetForEditorial();$scope.model={keywordText:''};var currentUrlParams=$stateParams.q;backButtonService.overrideForScopeLifetime($scope,{forceHide:true});commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'Back to News',state:{name:'editorial',params:{}}});commonViewModel.headerMenus.push({text:'New Search',state:{name:'editorialSearch',params:{}}});var navigate=function(state,params,selectedHashKey,selectedDisplayValue){if(angular.isString(params))
params=urlStringService.parse(params).search;if(selectedDisplayValue){params.sk=selectedDisplayValue;}
var breadCrumbState={t:'nav',sk:selectedHashKey};var breadcrumbs=navigationBreadcrumb.push(breadCrumbState);params.bc=angular.toJson(breadcrumbs);navigateService.go(state,params);};$scope.showResult=function(){$state.go("editorialListing",currentUrlParams);};$scope.removeCriteria=function(criteria){var params=urlStringService.parse(criteria.removeAction).search;reloadData(params);};$scope.selectCriteria=function(criteria){navigate('editorialSearchSelectAspect',criteria.explore,criteria.aspectName,criteria.displayValue);};var reloadData=function(params,callback){currentUrlParams=params;$scope.isLoading=true;editorialNavApiService.navigator(params,function(data){$scope.model=data;parseCriterias(data.criteriaElements);if(callback){callback();}
$scope.isLoading=false;});}
reloadData($stateParams,function(){var selectedIndex=$stateParams.sk;if(selectedIndex){scrollHelper.scrollToElement(''+selectedIndex,0,'top',3);}});var updateKeyword=function(query,keyword){query=query||'';query=deleteKeyword(query);if($scope.model.keywordText&&$scope.model.keywordText!=''){if(query!=''){query=query+'&';}
query=query+"keywords=keyword["+keyword+"]";}
return query;};var deleteKeyword=function(query){if(originalKeywordText&&originalKeywordText!=''){query=query.replace("&keywords=keyword["+originalKeywordText+"]",'');query=query.replace("keywords=keyword["+originalKeywordText+"]&",'');query=query.replace("keywords=keyword["+originalKeywordText+"]",'');}
return query;}
var originalKeywordText='';var parseCriterias=function(criterias){angular.forEach(criterias,function(criteria){if(criteria.criterionType=='Keyword'){$scope.model.keywordText=criteria.searchTerm||'';originalKeywordText=$scope.model.keywordText;}
if(criteria.selectedLeafElements||(criteria.children!=undefined)||criteria.min||criteria.max||criteria.selectedAdTypes){criteria.isSelected=true;}});};$scope.updateKeyword=function(bypassSameValue){if(!bypassSameValue&&originalKeywordText==$scope.model.keywordText)return;currentUrlParams.q=updateKeyword(currentUrlParams.q,$scope.model.keywordText);$state.go("editorialSearch",currentUrlParams,{reload:true});};}]);'use strict';editorialApp.controller('EditorialSearchSelectAspectController',['$scope','$state','navigateService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams','editorialNavApiService','$timeout','scrollHelper',function($scope,$state,navigateService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams,editorialNavApiService,$timeout,scrollHelper){commonViewModel.resetForEditorial();$scope.model={displayAsGroup:false,dataGroups:{}}
var jsonData=[];var getQuery=function(){var placeholder=jsonData.facetElements.filter(function(elem){return elem.isSelected;}).map(function(elem){return elem.nodeFamilyExpression||elem.nodeExpression;}).join('|');if(placeholder){return jsonData.multiSelectPlaceholder.replace('<!>',placeholder);}else{return jsonData.currentQueryPredicate;}}
var navigate=function(state,action,parent,selectedKey,breadcrumbs){var query=getQuery();var params={a:action,p:parent,q:query};if(breadcrumbs)
params.bc=angular.toJson(breadcrumbs);if(selectedKey)
params.sk=selectedKey;for(var key in params){if(params[key]===undefined)
delete params[key];}
navigateService.go(state,params);}
var goForwardOnElement=function(element){element.isSelected=true;goForward(element.traversableChildren[0],element.parentExpression,element.displayName);};var goForward=function(action,parent,selectedKey){var state={a:jsonData.name,p:jsonData.parentExpression,sk:selectedKey};navigate('editorialSearchSelectAspect',action,parent,undefined,navigationBreadcrumb.push(state));}
var goBack=function(){var peek=navigationBreadcrumb.peek();if(peek){if(peek.t==='nav'){navigate('editorialSearch',undefined,undefined,peek.sk);}else{navigate('editorialSearchSelectAspect',peek.a,peek.p,peek.sk,navigationBreadcrumb.pop());}}else{goBackToSearch();}};var goBackToSearch=function(){navigate("editorialSearch");};backButtonService.overrideForScopeLifetime($scope,{callback:goBack,forceShow:true});$scope.navigate=navigate;$scope.goForward=goForwardOnElement;$scope.goBackToSearch=goBackToSearch;$scope.isLoading=true;editorialNavApiService.aspect($stateParams,function(responseData){jsonData=responseData;if(!jsonData)return;var selectedIndex=0;var selectedKey=$stateParams.sk;var i=0;angular.forEach(jsonData.facetElements,function(elm){elm.index=i++;if(!selectedIndex&&selectedKey&&elm.displayName==selectedKey){selectedIndex=elm.index;}});$scope.model.dataGroups=[];$scope.model.displayAsGroup=(jsonData.name=='Make');if($scope.model.displayAsGroup){$scope.loadGroupData(selectedIndex);}else{$scope.model.dataItems=jsonData.facetElements;}
if(selectedIndex>0){scrollHelper.scrollToElement(''+selectedIndex,0,0,3);}
$scope.isLoading=false;});$scope.loadGroupData=function(selectedIndex){var currentGroup=null;selectedIndex=selectedIndex||0;var selectedGroup=null;for(var ctr=0;ctr<jsonData.facetElements.length;ctr++){var element=jsonData.facetElements[ctr];var key=element.displayName.charAt(0).toUpperCase();if(currentGroup==null||currentGroup.key!=key){currentGroup={key:key,values:[]};$scope.model.dataGroups.push(currentGroup);}
currentGroup.values.push(element);if(selectedIndex==ctr){selectedGroup=currentGroup;}};if(selectedGroup){$scope.selectGroup(selectedGroup,true);}};$scope.selectGroup=function(group,withoutScroll){if(group.key==$scope.selectedGroupKey){$scope.selectedGroupKey='';return;}
$scope.selectedGroupKey=group.key;if(!withoutScroll){$timeout(function(){scrollHelper.scrollToElement('grp-'+group.key,500,'top',0);},550);}};$scope.isThisGroupSelected=function(group){return($scope.selectedGroupKey==group.key);};}]);'use strict';editorialApp.directive('editorialLandingSection',[function(){return{templateUrl:'/apps/editorial/views/_editorial-landing-section.html',replace:true,scope:{section:'=',type:'=',title:'='}};}]);'use strict';editorialApp.directive('editorialListing',[function(){return{templateUrl:'/apps/editorial/views/_editorial-listing.html',scope:{datasource:'=',request:'='}};}]);'use strict';editorialApp.directive('editorialListingItem',['$state',function($state){return{templateUrl:'/apps/editorial/views/_editorial-listing-item.html',scope:{item:'=',request:'='},link:function(scope,elm,attrs){var p=angular.extend({},scope.request.params);p.id=scope.item.id;p.index=scope.item.itemIndex;scope.detailLink=$state.href('editorialDetail',p);}};}]);'use strict';editorialApp.directive('editorialSearchCriteria',[function(){return{templateUrl:'/apps/editorial/views/search/_editorial-search-criteria.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';editorialApp.directive('editorialSearchSelectAspectOptions',[function(){return{templateUrl:'/apps/editorial/views/search/_editorial-search-select-aspect-options.html',replace:true,scope:{options:'=',goForward:'=',}};}]);'use strict';editorialApp.factory('editorialDetailService',['$resource','globalSettings',function($resource,globalSettings){return $resource(globalSettings.apiBaseUrl+'editorials/:id');}]);'use strict';editorialApp.factory('editorialLandingService',['$resource','globalSettings',function($resource,globalSettings){return $resource(globalSettings.apiBaseUrl+'EditorialArticles');}]);'use strict';editorialApp.factory('editorialListingScrollDatasource',['editorialListingService','$q','$rootScope',function(editorialListingService,$q,$rootScope){var defaultPageLimit=10;var obj=function(params,startIndex,prepopulateDataWithLimit,prepopulateDataCallback){this.items=[];this.totalCount=0;this.adsCounter=0;this.isBusy=false;this.hasMoreData=true;this.criteria={q:params.q||'',limit:defaultPageLimit,skip:0,sort:params.sort||'latest',useMrecsOnMobile:params.useMrecs};this.startIndex=startIndex;this.itemCounterWithoutAds=startIndex;if(prepopulateDataWithLimit>0){this.criteria.limit=parseInt(prepopulateDataWithLimit)+defaultPageLimit;this.criteria.startIndex=prepopulateDataWithLimit;var ds=this;this.loadMoreData().then(function(){ds.criteria.limit=defaultPageLimit;if(angular.isFunction(prepopulateDataCallback)){prepopulateDataCallback();}});}};obj.prototype.loadMoreData=function(){var ds=this;if(ds.isBusy)return;if(!ds.hasMoreData)return;var deferred=$q.defer();ds.isBusy=true;ds.criteria.startIndex=ds.startIndex;ds.criteria.skip=ds.itemCounterWithoutAds;editorialListingService.get(ds.criteria).$promise.then(function(data){loadMoreDataCallback(data,ds);deferred.resolve();$rootScope.$broadcast('resultsLoadMore',{q:ds.criteria.q,skip:ds.criteria.skip,limit:ds.criteria.limit,sortBy:ds.criteria.sort,});});return deferred.promise;}
var loadMoreDataCallback=function(data,ds){for(var i=0;i<data.results.length;i++){var item=data.results[i];if(data.results[i].isAdvert){item.adsIndex=ds.adsCounter;ds.adsCounter++;}else{item.itemIndex=ds.itemCounterWithoutAds;ds.itemCounterWithoutAds++;}
ds.items.push(item);};ds.totalCount=data.count;ds.isBusy=false;if(ds.itemCounterWithoutAds>=ds.totalCount){ds.hasMoreData=false;}};return obj;}]);'use strict';editorialApp.factory('editorialListingService',['$resource','globalSettings',function($resource,globalSettings){return $resource(globalSettings.apiBaseUrl+'editorials?sortby=:sort');}]);'use strict';editorialApp.factory('editorialNavApiService',['$resource','globalSettings',function($resource,globalSettings){var navigatorResource=$resource(globalSettings.apiBaseUrl+'editoriallisting/navigator');var aspectResource=$resource(globalSettings.apiBaseUrl+'editoriallisting/aspects');return{navigator:function(params,successHandler,errorHandler){return navigatorResource.get(params,{},successHandler,errorHandler);},aspect:function(params,successHandler,errorHandler){return aspectResource.get(params,{},successHandler,errorHandler);}}}]);