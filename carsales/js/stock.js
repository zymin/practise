'use strict';var stockApp=angular.module('stockApp',['ngTouch','ngCookies','ui.router','ngResource','ngSanitize','ngMaterial','infinite-scroll','angular-carousel','csnGlobalSettings','csnAdvert','csnShareThis','csnCommon','csnVideoPlayer','csnCommentControl','csnTracking','csnNav','csnGeolocation','ngAnimate','toaster','duScroll','csnFormatter','csnMembership']);stockApp.config(['$stateProvider','$locationProvider','$urlRouterProvider','$httpProvider',function($stateProvider,$locationProvider,$urlRouterProvider,$httpProvider){$httpProvider.interceptors.push('httpErrorInterceptor');$httpProvider.defaults.withCredentials=true;}]);'use strict';stockApp.controller('StockDetailsController',['$scope','$stateParams','stockDetailService','commonViewModel','$location','$sce','scrollHelper',function($scope,$stateParams,stockDetailService,commonViewModel,$location,$sce,scrollHelper){commonViewModel.resetForStock();$scope.model={};$scope.request={};$scope.request.params=$stateParams;$scope.request.id=$stateParams.id;$scope.request.index=parseInt($stateParams.index||0);$scope.model.currentAbsUrl=$location.absUrl();stockDetailService.get({id:$scope.request.id},function(detail){if(detail){$scope.model.detail=detail;}});}]);'use strict';stockApp.controller('StockListingController',['$scope','$rootScope','$state','$stateParams','$q','stockListingDatasource','commonViewModel','headerMenuItem','globalSettings','membershipSaveSearch','stockSortService','slStorage','membershipTrackLocalSaves','$location','$anchorScroll',function($scope,$rootScope,$state,$stateParams,$q,stockListingDatasource,commonViewModel,headerMenuItem,globalSettings,membershipSaveSearch,stockSortService,slStorage,membershipTrackLocalSaves,$location,$anchorScroll){$scope.model={};$scope.listings={};$scope.request={};$scope.request.params=$stateParams;$scope.pagination={count:0,perPage:20,currentPage:1,isNext:false,isPrevious:false,upperPageBound:0,lowerPageBound:0};$scope.loading=false;$scope.storageAvailable=false;$scope.storageResultsKey='csnStockResults';$scope.storageQueryKey='csnStockQuery';var listingDatasource;commonViewModel.resetForStock();commonViewModel.headerText=$stateParams.title||"Results";commonViewModel.footerVisible=false;commonViewModel.showBeta=true;commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'Refine',state:{name:'stockSearch',params:$stateParams}});commonViewModel.headerMenus.push({text:'Sort',state:{name:'stockListingSortBy',params:$stateParams}});commonViewModel.headerMenus.push({text:'New Search',state:{name:'stockSearch',params:{}}});commonViewModel.headerMenus.push({text:'Save Search',broadcast:{name:'headerMenuClicked',params:'Save Search'}});commonViewModel.headerMenus.push({text:'Saved Favourites',url:{href:'/saved/?msrc=menu',target:'_self'}});commonViewModel.headerMenus.push({text:'Feedback',url:{href:'/feedback',target:'_self'}});$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){$scope.loading=true;listingDatasource=new stockListingDatasource($scope.request.params,parseInt($scope.pagination.perPage));if(toParams.page){loadPage(toParams.page);}else{loadPage(1);}});var init=function(){if(slStorage.available()&&slStorage.ready()){$scope.storageAvailable=true;}}
var loadPage=function(page){var dataLoaded=false;if($scope.storageAvailable){var loadedResults=loadResults();if(loadedResults){processResults(loadedResults,page);loadedResults=true;}}
if(!dataLoaded){listingDatasource.getData(page,function(data){processResults(data,page);persistResults(data);$scope.loading=false;});}};var processResults=function(data,page){$scope.listings.results=data.results;$scope.pagination.currentPage=page||1;$scope.pagination.count=data.count;$scope.pagination.lowerPageBound=getLowerPageBound();$scope.pagination.upperPageBound=getUpperPageBound();var newGtsList=[];angular.forEach(data.gtsAds,function(item){if(item.ad){newGtsList.push(item.ad);}});$scope.listings.gtsAds=newGtsList;if(data.count>(page*parseInt($scope.pagination.perPage))){$scope.pagination.isNext=true;}else{$scope.pagination.isNext=false;}
if(page>1){$scope.pagination.isPrevious=true;}else{$scope.pagination.isPrevious=false;}}
var loadResults=function(){var tempQuery=slStorage.retrieve($scope.storageQueryKey);if(compareObjects(tempQuery,$scope.request.params)){return slStorage.retrieve($scope.storageQueryKey);}else{return false;}}
var persistResults=function(data){if(slStorage.store($scope.storageResultsKey,data)){slStorage.store($scope.storageQueryKey,$scope.request.params);return true;}else{$scope.storageAvailable=false;return false;}}
var getLowerPageBound=function(){var page=parseInt($scope.pagination.currentPage-1);var lowerBound=(page*parseInt($scope.pagination.perPage))+1;return lowerBound;}
var getUpperPageBound=function(){var initialBound=$scope.pagination.lowerPageBound+($scope.pagination.perPage-1);if(initialBound<=$scope.pagination.count){return initialBound;}else{return $scope.pagination.count;}}
var compareObjects=function(a,b){var aStr=JSON.stringify(a);var bStr=JSON.stringify(b);return(aStr==bStr)?true:false;}
$scope.pagination.goNext=function(){if($scope.pagination.isNext){var page=parseInt($scope.pagination.currentPage)+1;saveHistoryState(page);goToTop();}};$scope.pagination.goPrevious=function(){if($scope.pagination.isPrevious){var page=parseInt($scope.pagination.currentPage)-1;saveHistoryState(page);goToTop();}};var goToTop=function(){$anchorScroll();}
var saveHistoryState=function(page){var newSearch=$location.search();newSearch.page=page;$location.search(newSearch);}
$scope.$on('headerMenuClicked',function(event,menuText){switch(menuText){case"Save Search":{membershipSaveSearch.showDialog(globalSettings.isAuthenticated,encodeURIComponent($stateParams.q||''));break;}}});init();}]);'use strict';stockApp.controller('StockListingSortByController',['$scope','$stateParams','commonViewModel','stockSortService','csnStorage','csnPostcodeKey',function($scope,$stateParams,commonViewModel,stockSortService,csnStorage,csnPostcodeKey){commonViewModel.resetForStock();commonViewModel.headerText='Sort by';$scope.model={};$scope.model.query=$stateParams.q;$scope.model.currentSort=$stateParams.sort;$scope.model.DistanceFromMePostcode=csnStorage.get(csnPostcodeKey);$scope.model.options=stockSortService.allSortOptions();$scope.model.basicOptions=[];$scope.model.advancedOptions=[];for(var counter=0;counter<$scope.model.options.length;counter++)
{if(!$scope.model.options[counter].isAdvancedSearchOption){$scope.model.basicOptions.push($scope.model.options[counter]);}else{$scope.model.advancedOptions.push($scope.model.options[counter]);if($scope.model.options[counter].key===$scope.model.currentSort){$scope.showAdvancedSearchOptions=true;}}}
$scope.toggleAdvancedSearchOptions=function(){$scope.showAdvancedSearchOptions=!$scope.showAdvancedSearchOptions;};}]);'use strict';stockApp.constant('csnPostcodeKey',"csnPostcode").controller('StockListingSortNearmeController',['$scope','$stateParams','commonViewModel','$state','stockPostcodeService','csnStorage','csnPostcodeKey',function($scope,$stateParams,commonViewModel,$state,stockPostcodeService,csnStorage,csnPostcodeKey){commonViewModel.resetForStock();commonViewModel.headerText='Near Me: Location';$scope.model={};$scope.model.query=$stateParams.q;$scope.model.sort=$stateParams.sort;$scope.model.DistanceFromMePostcode=csnStorage.get(csnPostcodeKey);$scope.triggerResults=function(){var postcodeValidator=new stockPostcodeService;if(postcodeValidator.validateUsingRegex($scope.model.DistanceFromMePostcode)){;var params={};params.q=$scope.model.query;params.sort=$scope.model.sort;csnStorage.add(csnPostcodeKey,$scope.model.DistanceFromMePostcode);if(typeof(dcsMultiTrack)==='function'){console.log('Tracking Event Fired');dcsMultiTrack('WT.dl','99','WT.z_distcalc','1','WT.conv','distance-from-me-update-postcode');}
var returnUrl=$stateParams.returnUrl;if(returnUrl){window.location=returnUrl+'?DistanceFromMePostcode='+$scope.model.DistanceFromMePostcode;}else{$state.go('stockListing',params);}}else{alert('Please enter a valid postcode.');}};}]);'use strict';stockApp.controller('StockSearchController',['$scope','$rootScope','navigateService','commonViewModel','backButtonService','$state','$stateParams','stockNavApiService','scrollHelper','navigationBreadcrumb','urlStringService','headerMenuItem','membershipTrackLocalSaves',function($scope,$rootScope,navigateService,commonViewModel,backButtonService,$state,$stateParams,stockNavApiService,scrollHelper,navigationBreadcrumb,urlStringService,headerMenuItem,membershipTrackLocalSaves){commonViewModel.resetForStock();$scope.model={keywordText:''};$scope.request={};$scope.request.params=$stateParams;$scope.currentUrlParams="";commonViewModel.emptyMenu();commonViewModel.headerMenus.push({text:'New Search',state:{name:'stockSearch',params:{q:''}}});$rootScope.$broadcast('changeContext','stock');var navigate=function(state,params,selectedHashKey,selectedDisplayName,selectedDisplayValue){if(angular.isString(params)){params=urlStringService.parse(params).search;}else{params={};}
if(selectedDisplayValue){params.sk=selectedDisplayValue;}
if(selectedDisplayName){params.d=selectedDisplayName;}
var breadCrumbState={t:'nav',sk:selectedHashKey};var breadcrumbs=navigationBreadcrumb.push(breadCrumbState);params.bc=angular.toJson(breadcrumbs);params.sort=$stateParams.sort;navigateService.go(state,params);};$scope.removeCriteria=function(criteria){var params=urlStringService.parse(criteria.removeAction).search;reloadData(params);};var navigateToRangeSelection=function(criteria){var currentQuery=$scope.currentUrlParams.q;if(criteria.removeAction){currentQuery=urlStringService.parse(criteria.removeAction).search.q;}
var params={q:currentQuery,a:criteria.aspectName,dn:criteria.displayName,min:criteria.min,max:criteria.max,sort:$stateParams.sort}
$state.go("stockSearchSelectRange",params);}
var navigateToPostcodeSelection=function(criteria){var currentQuery=$scope.currentUrlParams.q;if(criteria.removeAction){currentQuery=urlStringService.parse(criteria.removeAction).search.q;}
var params={q:currentQuery,a:criteria.aspectName,dn:criteria.displayName,postcode:criteria.postcode,distanceInKms:criteria.distanceInKms,sort:$stateParams.sort};$state.go("stockSearchSelectPostcode",params);};var navigateToAdTypeSelection=function(criteria){var params={q:urlStringService.parse(criteria.explore).search.q,a:criteria.aspectName,dn:criteria.displayName,sort:$stateParams.sort};$state.go("stockSearchSelectAdType",params);};var navigateToKeywordSelection=function(criteria){var currentQuery=$scope.currentUrlParams.q;if(criteria.removeAction){currentQuery=urlStringService.parse(criteria.removeAction).search.q;}
var params={q:currentQuery,a:criteria.aspectName,dn:criteria.displayName,postcode:criteria.postcode,distanceInKms:criteria.distanceInKms,sort:$stateParams.sort,DistanceFromMePostcode:$stateParams.DistanceFromMePostcode,keyword:criteria.searchTerm};$state.go("stockSearchSelectKeyword",params);};$scope.selectCriteria=function(criteria){if(criteria.criterionType==="Range"){navigateToRangeSelection(criteria);}else if(criteria.criterionType==="Postcode"){navigateToPostcodeSelection(criteria);}else if(criteria.criterionType==="AdType"){navigateToAdTypeSelection(criteria);}else if(criteria.criterionType==="Keyword"){navigateToKeywordSelection(criteria);}else{navigate('stockSearchSelectAspect',criteria.explore,criteria.aspectName,criteria.displayName,criteria.displayValue);}};var reloadData=function(params,callback){$scope.currentUrlParams=params;$scope.isLoading=true;stockNavApiService.navigator(params,function(data){$scope.model=data;parseCriterias(data.criteriaElements);if(callback){callback();}
$scope.isLoading=false;});}
reloadData($stateParams,function(){var selectedIndex=$stateParams.sk;if(selectedIndex){scrollHelper.scrollToElement(''+selectedIndex,0,'top',3);}});var parseCriterias=function(criterias){angular.forEach(criterias,function(criteria){if(criteria.selectedLeafElements||(criteria.children!=undefined)||criteria.min||criteria.max||criteria.selectedAdTypes||criteria.postcode||criteria.searchTerm){criteria.isSelected=true;}});};$scope.showAdvancedSearchForm=localStorage.showAdvancedSearchForm==='true';$scope.toggleAdvancedSearchForm=function(){$scope.showAdvancedSearchForm=!$scope.showAdvancedSearchForm;localStorage.showAdvancedSearchForm=$scope.showAdvancedSearchForm;};}]);'use strict';stockApp.controller('StockSearchSelectAdTypeController',['$scope','$state','navigateService','geolocationService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams','stockNavApiService',function($scope,$state,navigateService,geolocationService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams,stockNavApiService){commonViewModel.resetForStock();$scope.request={};$scope.request.params=$stateParams;$scope.model={currentQuery:$stateParams.q||"",aspectName:$stateParams.a,displayName:$stateParams.dn};commonViewModel.headerText=$scope.model.displayName;commonViewModel.emptyMenu();var getQuery=function(){var selectedAdTypeUIOptions=[];selectedAdTypeUIOptions=selectedAdTypeUIOptions.concat($scope.model.options.filter(function(option){return option.isSelected;}));var selectedQuery=selectedAdTypeUIOptions.map(function(option){return option.nodeExpression;}).join('|');if(selectedQuery){return $scope.model.aspect.multiSelectPlaceholder.replace('<!>',selectedQuery);}else{return $scope.model.aspect.removeAction;}};var goBackToSearch=function(useSelections){var originalParams={q:useSelections?getQuery():$scope.model.aspect.currentQueryPredicate,sk:$scope.model.aspectName,sort:$stateParams.sort};$state.go("stockSearch",originalParams);};var loadAdTypes=function(){var params={a:$scope.model.aspectName,q:$stateParams.q,ref:$stateParams.ref,debug:$stateParams.debug,sort:$stateParams.sort};stockNavApiService.aspect(params,function(data){$scope.model.aspect=data;$scope.model.options=mapAdTypeFacets(data.facetElements);});};var mapAdTypeFacets=function(facetElements){var adTypeUIOptions=[];var brandNewCarsInStockFacetElement=null;var brandNewCarsAvailableFacetElement=null;for(var index=0;index<facetElements.length;++index){var currentFacetElement=facetElements[index];if(currentFacetElement.displayName!="Brand new cars in stock"&&currentFacetElement.displayName!="Brand new cars available"){adTypeUIOptions.push(currentFacetElement);}
if(currentFacetElement.displayName=="Brand new cars in stock"){brandNewCarsInStockFacetElement=currentFacetElement;}
if(currentFacetElement.displayName=="Brand new cars available"){brandNewCarsAvailableFacetElement=currentFacetElement;}}
var brandNewCarsCount=0;var brandNewCarsInStockIsSelected=false;var brandNewCarsAvailableIsSelected=false;if(brandNewCarsInStockFacetElement){brandNewCarsCount=brandNewCarsCount+brandNewCarsInStockFacetElement.count;brandNewCarsInStockIsSelected=brandNewCarsInStockFacetElement.isSelected;}
if(brandNewCarsAvailableFacetElement){brandNewCarsCount=brandNewCarsCount+brandNewCarsAvailableFacetElement.count;brandNewCarsAvailableIsSelected=brandNewCarsAvailableFacetElement.isSelected;}
if(brandNewCarsInStockFacetElement||brandNewCarsAvailableFacetElement){adTypeUIOptions.splice(0,0,{displayName:"Brand new cars",count:brandNewCarsCount,isSelected:brandNewCarsInStockIsSelected&&brandNewCarsAvailableIsSelected,nodeExpression:$scope.model.aspectName+"=[Brand new cars in stock]|"+$scope.model.aspectName+"=[Brand new cars available]"});}
return adTypeUIOptions;};backButtonService.overrideForScopeLifetime($scope,{callback:goBackToSearch,forceShow:true});$scope.goBackToSearch=goBackToSearch;loadAdTypes();}]);'use strict';stockApp.constant("multiselectAndAspects",["AdsWith"]).controller('StockSearchSelectAspectController',['$scope','navigateService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams','multiselectAndAspects',function($scope,navigateService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams,multiselectAndAspects){commonViewModel.resetForStock();$scope.request={};$scope.request.params=$stateParams;$scope.model={aspects:[],activeTab:''};var getQuery=function(){var selectedElements=[];angular.forEach($scope.model.aspects,function(aspect){if(aspect.jsonData&&aspect.jsonData.facetElements){selectedElements=selectedElements.concat(aspect.jsonData.facetElements.filter(function(elem){return elem.isSelected;}));}});var joinOperation=multiselectAndAspects.indexOf($scope.model.activeTab)>-1?'&':'|';var selectedQuery=selectedElements.map(function(elem){return elem.nodeFamilyExpression||elem.nodeExpression;}).join(joinOperation);if(selectedQuery){return $scope.model.aspects[0].jsonData.multiSelectPlaceholder.replace('<!>','('+selectedQuery+')');}else{return $scope.model.aspects[0].jsonData.currentQueryPredicate;}}
var navigate=function(state,actions,parent,selectedKey,breadcrumbs){var query=getQuery();var params={a:actions,p:parent,q:query};if(breadcrumbs)
params.bc=angular.toJson(breadcrumbs);if(selectedKey)
params.sk=selectedKey;for(var key in params){if(params[key]===undefined)
delete params[key];}
params.sort=$stateParams.sort;navigateService.go(state,params);}
var goBack=function(){var peek=navigationBreadcrumb.peek();if(peek){if(peek.t==='nav'){navigate('stockSearch',undefined,undefined,peek.sk);}else{navigate('stockSearchSelectAspect',peek.a,peek.p,peek.sk,navigationBreadcrumb.pop());}}else{goBackToSearch();}};$scope.$on('optionSelected',function(event,facetElement){if($scope.model.aspects[0].jsonData.isMultiSelect){facetElement.isSelected=!facetElement.isSelected;}else{var params={q:facetElement.submit};navigateService.go('stockSearch',params);}});var goBackToSearch=function(){navigate("stockSearch");};backButtonService.overrideForScopeLifetime($scope,{callback:goBack,forceShow:true});$scope.goBackToSearch=goBackToSearch;var goForward=function(actions,parentExpression,selectedKey){var state={a:aspectsString,p:$scope.model.aspects[0].jsonData.parentExpression,sk:selectedKey};navigate('stockSearchSelectAspect',actions,parentExpression,undefined,navigationBreadcrumb.push(state));};$scope.$on('GoForwardClicked',function(event,facetElement){facetElement.isSelected=true;goForward(facetElement.traversableChildren.join(","),facetElement.parentExpression,facetElement.displayName);});$scope.$on('AspectListIsLoaded',function(event,aspectName){updateHeaderText();$scope.isLoading=false;});var updateHeaderText=function(){if($stateParams.d){commonViewModel.headerText=$stateParams.d;}else{var displayNames=[];angular.forEach($scope.model.aspects,function(aspect){displayNames.push(aspect.aspectName);});commonViewModel.headerText=displayNames.join(" and ");}};$scope.selectTab=function(tabName){$scope.model.activeTab=tabName;};$scope.isTabActive=function(tabName){return $scope.model.activeTab===tabName;};var aspectsString=$stateParams.a;function init(){$scope.isLoading=true;aspectsString=$stateParams.a;if(!aspectsString)return;var aspects=aspectsString.split(",");angular.forEach(aspectsString.split(","),function(aspectName){$scope.model.aspects.push({aspectName:aspectName,jsonData:[]});});$scope.model.activeTab=aspects[0];}
init();}]);'use strict';stockApp.controller('StockSearchSelectKeywordController',['$scope','$state','navigateService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams',function($scope,$state,navigateService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams){commonViewModel.resetForStock();$scope.request={};$scope.request.params=$stateParams;$scope.model={currentQuery:$stateParams.q||"",aspectName:$stateParams.a,displayName:$stateParams.dn,keyword:$stateParams.keyword,distanceInKms:($stateParams.distanceInKms?$stateParams.distanceInKms:"10")};commonViewModel.headerText=$scope.model.displayName;var getQuery=function(){var q=$scope.model.currentQuery||"";var newQuery="";var qBits=q.split("&");for(var x=0;x<qBits.length;x++){if(qBits[x].indexOf("CarAll")>=0)
continue;if(newQuery.length>0)
newQuery+="&";newQuery+=qBits[x];}
if(!$scope.model.keyword)
return newQuery;if(newQuery.length>0)
newQuery+="&";newQuery+="CarAll=keyword["+$scope.model.keyword+"]";return newQuery;};var goBackToSearch=function(){var originalParams={q:getQuery(),sk:$scope.model.aspectName,sort:$stateParams.sort,DistanceFromMePostcode:$stateParams.DistanceFromMePostcode,keyword:$scope.model.keyword};$state.go("stockSearch",originalParams);};backButtonService.overrideForScopeLifetime($scope,{callback:goBackToSearch,forceShow:true});$scope.goBackToSearch=goBackToSearch;}]);'use strict';stockApp.controller('StockSearchSelectPostcodeController',['$scope','$state','navigateService','postcodeService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams',function($scope,$state,navigateService,postcodeService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams){commonViewModel.resetForStock();$scope.request={};$scope.request.params=$stateParams;$scope.model={currentQuery:$stateParams.q||"",aspectName:$stateParams.a,displayName:$stateParams.dn,postcode:parseInt($stateParams.postcode),distanceInKms:($stateParams.distanceInKms?$stateParams.distanceInKms:"10")};commonViewModel.headerText=$scope.model.displayName;var getQuery=function(postcode,distanceInKms){var q=$scope.model.currentQuery||"";if(!postcode||!distanceInKms)
return q;if(q!=""){q+="&";}
q+="Postcode=poi["+postcode+"x"+distanceInKms+"km]";return q;};var goBackToSearch=function(checkPostcode){var newQ;if($scope.model.postcode){newQ=getQuery($scope.model.postcode,$scope.model.distanceInKms);}else{newQ=$scope.model.currentQuery||"";}
var params={q:newQ,sk:$scope.model.aspectName,sort:$stateParams.sort};$state.go("stockSearch",params);};var searchNearMe=function(){function successHandler(geo){var longPos=geo.coords.longitude.toFixed(2),latPos=geo.coords.latitude.toFixed(2);postcodeService.get({latitude:latPos,longitude:longPos}).$promise.then(function(result){navigateToSearch(getQuery(result.postcode,$scope.model.distanceInKms),$scope.model.aspectName,$stateParams.sort);},function(){alert('Couldn\'t resolve your current location to a postcode. Please enter your postcode manually.');});}
function errorHandler(error){alert("Your current location is not available.");if(window.console){switch(error.code){case error.TIMEOUT:console.log('geolocation: Timeout');break;case error.POSITION_UNAVAILABLE:console.log('geolocation: Position unavailable');break;case error.PERMISSION_DENIED:console.log('geolocation: Permission denied');break;case error.UNKNOWN_ERROR:console.log('geolocation: Unknown error');break;}}}
if(navigator&&typeof(navigator.geolocation)=='object'){navigator.geolocation.getCurrentPosition(successHandler,errorHandler,{maximumAge:0});}else{alert("Location services is not supported on your device.");}};var navigateToSearch=function(q,sk,sort){var params={q:q,sk:sk,sort:sort};$state.go("stockSearch",params);};backButtonService.overrideForScopeLifetime($scope,{callback:goBackToSearch,forceShow:true});$scope.goBackToSearch=goBackToSearch;$scope.searchNearMe=searchNearMe;}]);'use strict';stockApp.controller('StockSearchSelectRangeController',['$scope','$state','navigateService','navigationBreadcrumb','commonViewModel','backButtonService','$stateParams',function($scope,$state,navigateService,navigationBreadcrumb,commonViewModel,backButtonService,$stateParams){commonViewModel.resetForStock();$scope.request={};$scope.request.params=$stateParams;$scope.model={currentQuery:$stateParams.q||"",aspectName:$stateParams.a,displayName:$stateParams.dn,min:$stateParams.min,max:$stateParams.max}
commonViewModel.headerText=$scope.model.displayName;var getQuery=function(){var q=$scope.model.currentQuery||"";if(!$scope.model.min&&!$scope.model.max)
return q;var min=parseInt($scope.model.min);var max=parseInt($scope.model.max);if(min<0||isNaN(min))
min=0;if(max<0||isNaN(max))
max=0;if(min==0&&max==0)
return q;if(min>0&&max>0&&max<min){var t=min;min=max;max=t;}
var minStr="";var maxStr="";if(min>0){minStr=min;}
if(max>0){maxStr=max;}
if(q!=""){q+="&";}
q+=$scope.model.aspectName+"=range["+minStr+".."+maxStr+"]";return q;}
var goBackToSearch=function(){var params={q:getQuery(),sk:$scope.model.aspectName,sort:$stateParams.sort};$state.go("stockSearch",params);};backButtonService.overrideForScopeLifetime($scope,{callback:goBackToSearch,forceShow:true});$scope.goBackToSearch=goBackToSearch;}]);'use strict';stockApp.directive("csnCarFavourite",["membershipCarLocalStorage","membershipCarStorage","globalSettings",function(membershipCarLocalStorage,membershipCarStorage,globalSettings){return function(scope,element,attrs){function getStorageProvider(){if(globalSettings.isAuthenticated=='true'||globalSettings.isAuthenticated==true){return membershipCarStorage;}
return membershipCarLocalStorage;}
var car=scope[attrs["csnCarFavourite"]];var markAsSaved=function(){element.addClass('is-saved');};var markAsUnsaved=function(){element.removeClass('is-saved');car.saved=false;};var clickHandler=function(event){getStorageProvider().isSaved(car,function(exists){if(exists==true){getStorageProvider().unsave(car,markAsUnsaved);}else{getStorageProvider().save(car,markAsSaved);}});event.preventDefault();};getStorageProvider().isSaved(car,function(exists){if(exists==true){markAsSaved();}});element.on('click',clickHandler);};}]);'use strict';stockApp.directive('stockListing',[function(){return{templateUrl:'/apps/stock/views/_stock-listing.html',scope:{pagination:'=',datasource:'=',request:'='}};}]).directive('csnLazySrc',function($window,$document){var lazyLoader=(function(){var images=[];var renderTimer=null;var renderDelay=100;var win=$window;var doc=angular.element($document);var documentHeight=doc.clientHeight;var documentTimer=null;var documentDelay=2000;var isWatchingWindow=false;function addImage(image){images.push(image);if(!renderTimer){startRenderTimer();}
if(!isWatchingWindow){startWatchingWindow();}}
function removeImage(image){for(var i=0;i<images.length;i++){if(images[i]===image){images.splice(i,1);break;}}
if(!images.length){clearRenderTimer();stopWatchingWindow();}}
function checkDocumentHeight(){if(renderTimer){return;}
var currentDocumentHeight=doc.clientHeight;if(currentDocumentHeight===documentHeight){return;}
documentHeight=currentDocumentHeight;startRenderTimer();}
function checkImages(){var visible=[];var hidden=[];var windowHeight=win.innerHeight;var scrollTop=win.scrollY;var topFoldOffset=scrollTop-800;var bottomFoldOffset=(scrollTop+windowHeight+1200);for(var i=0;i<images.length;i++){var image=images[i];if(image.isVisible(topFoldOffset,bottomFoldOffset)){visible.push(image);}else{hidden.push(image);}}
for(var i=0;i<visible.length;i++){visible[i].render();}
images=hidden;clearRenderTimer();if(!images.length){stopWatchingWindow();}}
function clearRenderTimer(){clearTimeout(renderTimer);renderTimer=null;}
function startRenderTimer(){renderTimer=setTimeout(checkImages,renderDelay);}
function startWatchingWindow(){isWatchingWindow=true;angular.element(win).on('resize',windowChanged);angular.element(win).on('scroll',windowChanged);documentTimer=setInterval(checkDocumentHeight,documentDelay);}
function stopWatchingWindow(){isWatchingWindow=false;angular.element(win).off('resize');angular.element(win).off('scroll');clearInterval(documentTimer);}
function windowChanged(){if(!renderTimer){startRenderTimer();}}
return({addImage:addImage,removeImage:removeImage});})();function LazyImage(element){var source=null;var isRendered=false;var height=null;function isVisible(topFoldOffset,bottomFoldOffset){if(element[0]){element=element[0];}
if(height===null){height=element.offsetHeight;}
var top=element.offsetTop;var bottom=(top+height);return(((top<=bottomFoldOffset)&&(top>=topFoldOffset))||((bottom<=bottomFoldOffset)&&(bottom>=topFoldOffset))||((top<=topFoldOffset)&&(bottom>=bottomFoldOffset)));}
function render(){isRendered=true;renderSource();}
function setSource(newSource){source=newSource;if(isRendered){renderSource();}}
function renderSource(){element.onload=function(){var el_class=element.className+' in';element.className=el_class;};element.src=source;}
return({isVisible:isVisible,render:render,setSource:setSource});}
function link($scope,element,attributes){var lazyImage=new LazyImage(element);lazyLoader.addImage(lazyImage);attributes.$observe('csnLazySrc',function(newSource){lazyImage.setSource(newSource);});$scope.$on('$destroy',function(){lazyLoader.removeImage(lazyImage);});}
return({link:link,restrict:'A'});});'use strict';stockApp.directive('stockListingItem',['csnStorage',function(csnStorage){return{templateUrl:'/apps/stock/views/_stock-listing-item.html',scope:{item:'=',request:'='},link:function(scope,elm,attrs){scope.detailLink=scope.item.detailLink;var postcode=csnStorage.get("csnPostcode");if(postcode){scope.detailLink+='?DistanceFromMePostcode='+postcode;}
scope.goToDetailClicked=function(){};}};}]);'use strict';stockApp.directive('stockSearchCriteriaAdtype',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-adtype.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';stockApp.directive('stockSearchCriteriaAspect',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-aspect.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';stockApp.directive('stockSearchCriteriaAspectRecursive',['$compile',function($compile){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-aspect-recursive.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='},link:function(scope,element,attrs){if(scope.criterion&&angular.isArray(scope.criterion.children)){element.append('<div ng-repeat="criterionChild in criterion.children">'+'<div data-stock-search-criteria-aspect-recursive data-criterion="criterionChild" data-select-criteria="selectCriteria" data-remove-criteria="removeCriteria" class="border-top"></div>'+'</div>');$compile(element.contents())(scope);}}};}]);'use strict';stockApp.directive('stockSearchCriteriaKeyword',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-keyword.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';stockApp.directive('stockSearchCriteriaPostcode',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-postcode.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';stockApp.directive('stockSearchCriteriaRange',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-criteria-range.html',restrict:'EA',scope:{criterion:'=',selectCriteria:'=',removeCriteria:'='}};}]);'use strict';stockApp.directive('stockSearchSelectAspectList',['$stateParams','stockNavApiService','$timeout','scrollHelper',function($stateParams,stockNavApiService,$timeout,scrollHelper){return{templateUrl:'/apps/stock/views/search/_stock-search-select-aspect-list.html',restrict:'EA',scope:{aspect:'='},link:function(scope,element,attrs){scope.model={displayAsGroup:false,dataGroups:{}}
scope.selectGroup=function(group,withoutScroll){if(group.key==scope.selectedGroupKey){scope.selectedGroupKey='';return;}
scope.selectedGroupKey=group.key;if(!withoutScroll){$timeout(function(){scrollHelper.scrollToElement('grp-'+group.key,500,'top',0);},550);}};scope.isThisGroupSelected=function(group){return(scope.selectedGroupKey==group.key);};var loadAspect=function(){var params={a:scope.aspect.aspectName,p:$stateParams.p,q:$stateParams.q,ref:$stateParams.ref,debug:$stateParams.debug,};var selectedKey=$stateParams.sk;loadAspectWithParams(params,selectedKey);};var loadAspectWithParams=function(params,selectedKey){scope.isLoading=true;stockNavApiService.aspect(params,function(responseData){if(!responseData)return;scope.aspect.jsonData=responseData;var selectedIndex=0;var i=0;angular.forEach(scope.aspect.jsonData.facetElements,function(elm){elm.index=i++;if(!selectedIndex&&selectedKey&&elm.displayName==selectedKey){selectedIndex=elm.index;}});scope.model.dataGroups=[];scope.model.displayAsGroup=(scope.aspect.aspectName=='Make');scope.model.isMultiSelect=scope.aspect.jsonData.isMultiSelect;if(scope.model.displayAsGroup){bindGroupData(selectedIndex,scope.aspect.jsonData.facetElements);}else{scope.model.dataItems=scope.aspect.jsonData.facetElements;}
if(selectedIndex>0){scrollHelper.scrollToElement(''+selectedIndex,0,0,3);}
scope.isLoading=false;scope.$emit('AspectListIsLoaded',scope.aspect);});};var bindGroupData=function(selectedIndex,facetElements){var currentGroup=null;selectedIndex=selectedIndex||0;var selectedGroup=null;for(var ctr=0;ctr<facetElements.length;ctr++){var element=facetElements[ctr];var key=element.displayName.charAt(0).toUpperCase();if(currentGroup==null||currentGroup.key!=key){currentGroup={key:key,values:[]};scope.model.dataGroups.push(currentGroup);}
currentGroup.values.push(element);if(selectedIndex==ctr){selectedGroup=currentGroup;}};if(selectedGroup){scope.selectGroup(selectedGroup,true);}};function init(){loadAspect();}
init();}};}]);'use strict';stockApp.directive('stockSearchSelectAspectOptions',[function(){return{templateUrl:'/apps/stock/views/search/_stock-search-select-aspect-options.html',replace:true,scope:{options:'=',isMultiSelect:'='},link:function(scope,element,attrs){scope.goForward=function(facetElement){scope.$emit("GoForwardClicked",facetElement);};scope.optionSelected=function(facetElement){scope.$emit("optionSelected",facetElement);};}};}]);stockApp.filter('distanceString',function(){return function(input){var replaced=input;replaced=replaced.replace('<','Less than');replaced=replaced.replace('>','More than');return replaced;}});'use strict'
stockApp.filter('gtsgcUrl',function(){return function(input,gts,gc,seller,itemid){var replaced=input;if(gts){if(input.indexOf('?')>-1){replaced=replaced+'&gts='+seller+'&gtssaleid='+itemid;}else{replaced=replaced+'?gts='+seller+'&gtssaleid='+itemid;}}else if(gc){if(input.indexOf('?')>-1){replaced=replaced+'&isGC=true';}else{replaced=replaced+'?isGC=true';}}
return replaced;};});'use strict';stockApp.factory('stockDetailService',['$resource','globalSettings',function($resource,globalSettings){return $resource(globalSettings.apiBaseUrl+'cars/:id');}]);'use strict';stockApp.factory('stockListingDatasource',['$resource','$q','$rootScope','globalSettings','stockListingService','csnStorage','csnPostcodeKey',function($resource,$q,$rootScope,globalSettings,stockListingService,csnStorage,csnPostcodeKey){var obj=function(params,limit){this.isBusy=false;this.pageLimit=limit||10;this.criteria={q:params.q||'',sort:params.sort||'TopDeal',DistanceFromMePostcode:csnStorage.get(csnPostcodeKey),useMrecsOnMobile:params.useMrecs};}
obj.prototype.getData=function(page,loadDataCallback){if(page>0){var skip=(parseInt(page)-1)*this.pageLimit;}else{skip=0;}
var query={q:this.criteria.q,sort:this.criteria.sort,useMrecsOnMobile:this.criteria.sort,DistanceFromMePostcode:this.criteria.DistanceFromMePostcode,limit:this.pageLimit,skip:skip}
stockListingService.get(query).$promise.then(function(data){if(loadDataCallback){loadDataCallback(data);}
$rootScope.$broadcast('resultsLoadMore',{q:query.q,sortby:query.sort,useMrecsOnMobile:query.useMrecsOnMobile,DistanceFromMePostcode:query.DistanceFromMePostcode,skip:query.skip,limit:query.limit});});}
return obj;}]);'use strict';stockApp.factory('stockListingScrollDatasource',['stockListingService','$q','$rootScope',function(stockListingService,$q,$rootScope){var defaultPageLimit=10;var obj=function(params,startIndex,prepopulateDataWithLimit,prepopulateDataCallback){this.items=[];this.gtsItems=[];this.totalCount=0;this.adsCounter=0;this.isBusy=false;this.hasMoreData=true;this.criteria={q:params.q||'',limit:defaultPageLimit,skip:0,sort:params.sort||'TopDeal',useMrecsOnMobile:params.useMrecs};this.itemCounterWithoutAds=startIndex;if(prepopulateDataWithLimit>0){this.criteria.limit=parseInt(prepopulateDataWithLimit)+defaultPageLimit;this.criteria.startIndex=prepopulateDataWithLimit;var ds=this;this.loadMoreData().then(function(){ds.criteria.limit=defaultPageLimit;if(angular.isFunction(prepopulateDataCallback)){prepopulateDataCallback();}});}};obj.prototype.loadMoreData=function(){var ds=this;if(ds.isBusy)return;if(!ds.hasMoreData)return;var deferred=$q.defer();ds.isBusy=true;ds.criteria.skip=ds.itemCounterWithoutAds;stockListingService.get(ds.criteria).$promise.then(function(data){loadMoreDataCallback(data,ds);deferred.resolve();$rootScope.$broadcast('resultsLoadMore',{skip:ds.criteria.skip,limit:ds.criteria.limit});});return deferred.promise;}
var loadMoreDataCallback=function(data,ds){if(ds.gtsItems.length<=0){ds.gtsItems=data.gtsAds;}
for(var i=0;i<data.results.length;i++){var item=data.results[i];if(data.results[i].isAdvert){item.adsIndex=ds.adsCounter;ds.adsCounter++;item.skip=ds.criteria.skip;item.limit=ds.criteria.limit;item.sortby=ds.criteria.sort;}else{item.itemIndex=ds.itemCounterWithoutAds;ds.itemCounterWithoutAds++;}
ds.items.push(item);};ds.totalCount=data.count;ds.isBusy=false;if(ds.itemCounterWithoutAds>=ds.totalCount){ds.hasMoreData=false;}};return obj;}]);'use strict';stockApp.factory('stockListingService',['$resource','globalSettings',function($resource,globalSettings){return $resource(globalSettings.apiBaseUrl+'cars?sortby=:sort');}]);'use strict';stockApp.factory('stockNavApiService',['$resource','globalSettings',function($resource,globalSettings){var navigatorResource=$resource(globalSettings.apiBaseUrl+'carlisting/navigator');var aspectResource=$resource(globalSettings.apiBaseUrl+'carlisting/aspects');return{navigator:function(params,successHandler,errorHandler){return navigatorResource.get(params,{},successHandler,errorHandler);},aspect:function(params,successHandler,errorHandler){if(params.q){}
return aspectResource.get(params,{},successHandler,errorHandler);}}}]);'use strict';stockApp.factory('stockPostcodeService',[function(){var obj=function(){}
obj.prototype.validateUsingRegex=function(postcode){var australianPostcodeRegex=/^((0[289][0-9]{2})|([1345689][0-9]{3})|(2[0-8][0-9]{2})|(290[0-9])|(291[0-4])|(7[0-4][0-9]{2})|(7[8-9][0-9]{2}))*$/;return australianPostcodeRegex.test(postcode);}
obj.prototype.validateUsingWebservice=function(postcode){console.log('Webservice validation method is unavailable until an endpoint exists to service the request.');}
return obj;}]);'use strict';stockApp.factory('stockSortService',function(){var allSortOptions=function(){return[{text:'Featured',key:'TopDeal'},{text:'Price (Low to High)',key:'~Price'},{text:'Price (High to Low)',key:'Price'},{text:'Kms (High to Low)',key:'Odometer'},{text:'Kms (Low to High)',key:'~Odometer'},{text:'Year Made (High to Low)',key:'Year'},{text:'Year Made (Low to High)',key:'~Year'},{text:'Distance from me',key:'NearestNeighbour'},{text:'Last Updated',key:'LastUpdated'},{text:'Make-Model (A-Z)',key:'MakeModel',isAdvancedSearchOption:'true'},{text:'Make-Model (Z-A)',key:'~MakeModel',isAdvancedSearchOption:'true'},{text:'Torque (High to Low)',key:'Torque',isAdvancedSearchOption:'true'},{text:'Power (High to Low)',key:'Power',isAdvancedSearchOption:'true'},{text:'Acceleration (High to Low)',key:'Acceleration',isAdvancedSearchOption:'true'},{text:'Fuel Economy (Low to High)',key:'FuelCombined',isAdvancedSearchOption:'true'},{text:'Remaining Rego (Most to Least)',key:'RegoExpiry',isAdvancedSearchOption:'true'},{text:'ANCAP Rating (High to Low)',key:'AncapRating',isAdvancedSearchOption:'true'}];};var sortOptionDisplayText=function(key){var displayText="";var options=allSortOptions();for(var counter=0;counter<options.length;counter++){if(options[counter].key===key){displayText=options[counter].text;}}
return displayText;}
return{allSortOptions:allSortOptions,sortOptionDisplayText:sortOptionDisplayText};});